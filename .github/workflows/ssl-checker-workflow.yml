name: Test Swift Tools and NTRIP Stream

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  test-streaming-job:
    runs-on: ubuntu-latest
    env:
      NTRIP_USERNAME: ${{ secrets.NTRIP_USERNAME }}
      NTRIP_PASSWORD: ${{ secrets.NTRIP_PASSWORD }}
      
      # IMPORTANT: Make sure these two values are still correct!
      SWIFT_TOOLS_URL: "https://github.com/swift-nav/swift-cli/releases/download/v0.20.0/swift-cli-v0.20.0-x86_64-apple-darwin.tar.gz"
      EXPECTED_FILE_SIZE: 44397837Â 

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Setup Swift Tools
        run: |
          echo "### Downloading and installing Swift Tools... ###"
          curl -L -o swift-tools.tar.gz "${{ env.SWIFT_TOOLS_URL }}"
          
          ACTUAL_SIZE=$(wc -c < swift-tools.tar.gz)     
          # --- CORRECTED COMPARISON USING ENVIRONMENT VARIABLE ---
          # Use the environment variable directly for a cleaner check
          if [ "$ACTUAL_SIZE" -ne "${{ env.EXPECTED_FILE_SIZE }}" ]; then
            echo "Error: Downloaded file size is incorrect. Expected ${{ env.EXPECTED_FILE_SIZE }}, got $ACTUAL_SIZE."
            exit 1
          fi
          # --------------------------------------------------------
          
          mkdir -p $HOME/swift-tools
          tar -xz swift-cli-v0.20.0-x86_64-apple-darwin.tar.gz -C $HOME/swift-tools
          
          echo "$HOME/swift-tools" >> $GITHUB_PATH
          echo "Tools are ready."

          # --- VERIFICATION CHECKS ---
          echo "### Verifying swift CLI installation... ###"
          
          # 1. Check if the main 'swift' command is accessible in PATH
          if ! command -v swift &> /dev/null
          then
              echo "Error: 'swift' command not found in PATH."
              exit 1
          fi
          echo "Success: 'swift' executable is accessible."
          
          # 2. Check a basic subcommand's functionality
          if ! swift rtcm32json --help &> /dev/null
          then
              echo "Error: 'swift rtcm32json' subcommand failed to execute."
              exit 1
          fi
          echo "Success: 'swift rtcm32json' subcommand is functional."
          # ---------------------------

      - name: Run a 10-second Test Stream with Debugging
        env:
          GITHUB_TOKEN: ${{ secrets.SECRETS_PAT }}
        run: |
          echo "[1/4] Starting debug checks..."
          set -o pipefail

          echo "[2/4] Verifying we can write to the output file..."
          touch log.rtcm.json.test
          if [ $? -ne 0 ]; then
            echo "Error: Could not create the output file. Check directory permissions."
            exit 1
          fi
          echo "Success: Output file 'log.rtcm.json.test' is writeable."
          ls -l log.rtcm.json.test

          echo "[3/4] Verifying the 'rtcm32json' tool is functional..."
          swift rtcm32json --help > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "Error: The 'swift rtcm32json' command failed to respond."
            exit 1
          fi
          echo "Success: 'swift rtcm32json' tool appears to be working."

          echo "[4/4] Attempting to connect, log in, and stream data..."
          # FIX 1: Changed -vv to the correct --verbose flag
          timeout 10s swift ntripping --verbose \
            --username "${{ env.NTRIP_USERNAME }}" \
            --password "${{ env.NTRIP_PASSWORD }}" \
            --url https://eu.l1l2.skylark.swiftnav.com:2102/SSR-integrity \
            --lat 52.149 \
            --lon 13.096 | swift rtcm32json > log.rtcm.json.test
        # FIX 2: Corrected the indentation of this line
        continue-on-error: true

        
          

      - name: Upload Test Log File
        uses: actions/upload-artifact@v4
        with:
          name: ntrip-test-log
          path: log.rtcm.json.test
